<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamepad Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
            position: relative;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
        }
        .lang-switch {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
        .lang-btn {
            width: 40px;
            height: 40px;
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            background-size: cover;
            background-position: center;
            border-radius: 5px;
            padding: 0;
        }
        .lang-btn.lang-en-btn {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 190 100"%3E%3Cg%3E%3Crect width="190" height="7.69" fill="%23B22234"/%3E%3Crect width="190" height="7.69" y="7.69" fill="white"/%3E%3Crect width="190" height="7.69" y="15.38" fill="%23B22234"/%3E%3Crect width="190" height="7.69" y="23.07" fill="white"/%3E%3Crect width="190" height="7.69" y="30.76" fill="%23B22234"/%3E%3Crect width="190" height="7.69" y="38.45" fill="white"/%3E%3Crect width="190" height="7.69" y="46.14" fill="%23B22234"/%3E%3Crect width="190" height="7.69" y="53.83" fill="white"/%3E%3Crect width="190" height="7.69" y="61.52" fill="%23B22234"/%3E%3Crect width="190" height="7.69" y="69.21" fill="white"/%3E%3Crect width="190" height="7.69" y="76.9" fill="%23B22234"/%3E%3Crect width="190" height="7.69" y="84.59" fill="white"/%3E%3Crect width="190" height="7.69" y="92.28" fill="%23B22234"/%3E%3Crect width="76" height="53.85" fill="%233C3B6E"/%3E%3C/g%3E%3C/svg%3E');
        }
        .lang-btn.lang-zh-btn {
            background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200"%3E%3Crect width="300" height="200" fill="%23de2910"/%3E%3Cg fill="%23ffde00"%3E%3Cpath d="M60,30 l20,60 l-50,-40 h62 l-50,40 z"/%3E%3Cpath d="M120,10 l5,15 l-12,-10 h15 l-12,10 z"/%3E%3Cpath d="M140,25 l5,15 l-12,-10 h15 l-12,10 z"/%3E%3Cpath d="M140,50 l5,15 l-12,-10 h15 l-12,10 z"/%3E%3Cpath d="M120,65 l5,15 l-12,-10 h15 l-12,10 z"/%3E%3C/g%3E%3C/svg%3E');
        }
        .lang-btn:hover {
            opacity: 0.8;
            transform: scale(1.05);
            border-color: #007bff;
        }
        .lang-btn.active {
            opacity: 1;
            transform: scale(1.1);
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
        }
        .lang-en { display: inline; }
        .lang-zh { display: none; }
        body.zh .lang-en { display: none; }
        body.zh .lang-zh { display: inline; }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .status {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        .reset-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
        }
        .reset-btn:hover {
            background-color: #c82333;
        }
        .gamepad {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .gamepad-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: flex-start;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .button-circle {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(145deg, #e9ecef, #ffffff);
            border: 3px solid #dee2e6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.066s ease;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .button-circle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .button-circle.pressed {
            background: linear-gradient(145deg, #28a745, #34ce57);
            border-color: #1e7e34;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
        }
        .button-name {
            font-weight: bold;
            font-size: 10px;
            margin-bottom: 3px;
            text-align: center;
            line-height: 1;
        }
        .button-count {
            font-size: 16px;
            font-weight: bold;
            color: #007bff;
        }
        .button-circle.pressed .button-count {
            color: white;
        }
        /* ç‰¹æ®ŠæŒ‰é’®é¢œè‰² */
        .button-circle.action {
            background: linear-gradient(145deg, #ffeaa7, #fdcb6e);
            border-color: #e17055;
        }
        .button-circle.shoulder {
            background: linear-gradient(145deg, #a29bfe, #6c5ce7);
            color: white;
        }
        .button-circle.dpad {
            background: linear-gradient(145deg, #fd79a8, #e84393);
            color: white;
        }
        .button-circle.system {
            background: linear-gradient(145deg, #636e72, #2d3436);
            color: white;
        }
        .axes-section {
            margin-top: 20px;
        }
        .axes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
            gap: 10px;
        }
        .axis-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        .axis-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 12px;
        }
        .axis-value {
            font-size: 11px;
            font-family: monospace;
            margin-top: 5px;
            color: #495057;
        }
        .axis-bar {
            width: 35%;
            height: 100px;
            background: linear-gradient(to bottom, #e9ecef 0%, #f8f9fa 50%, #e9ecef 100%);
            border: 1px solid #ced4da;
            border-radius: 4px;
            position: relative;
            margin: 5px auto;
        }
        .axis-indicator {
            position: absolute;
            width: 200%;
            height: 6px;
            background: #007bff;
            border-radius: 3px;
            box-shadow: 0 0 4px rgba(0, 123, 255, 0.5);
            left: -50%;
            z-index: 10;
        }
        .axis-trail {
            position: absolute;
            width: 200%;
            height: 4px;
            background: #007bff;
            border-radius: 2px;
            left: -50%;
            pointer-events: none;
            transition: opacity 0.6s ease;
        }
        .axis-center-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #6c757d;
            transform: translateY(-50%);
        }

        .stick-2d {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            grid-column: span 2;
        }
        .stick-2d-canvas {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
            border: 2px solid #ced4da;
            border-radius: 50%;
            position: relative;
            margin: 5px auto;
        }
        .stick-2d-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 2px;
            background: #6c757d;
            transform: translate(-50%, -50%);
        }
        .stick-2d-cross-h {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #adb5bd;
            transform: translateY(-50%);
        }
        .stick-2d-cross-v {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #adb5bd;
            transform: translateX(-50%);
        }
        .stick-2d-indicator {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #007bff;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .stick-2d-trail {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #007bff;
            transform: translate(-50%, -50%);
            pointer-events: none;
            transition: opacity 0.6s ease;
        }
        .stick-2d-value {
            font-size: 11px;
            font-family: monospace;
            margin-top: 5px;
            color: #495057;
        }

        .button-group {
            margin-bottom: 20px;
        }
        .button-group-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: left;
        }

        /* HID LED æ§åˆ¶é¢æ¿æ ·å¼ */
        .hid-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .hid-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #ffc107;
            padding-bottom: 10px;
        }
        .hid-status {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            text-align: center;
        }
        .hid-status.connected {
            background-color: #d4edda;
            color: #155724;
        }
        .hid-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .hid-connect-btn {
            display: block;
            margin: 0 auto 15px;
            background-color: #ffc107;
            color: #333;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
        }
        .hid-connect-btn:hover {
            background-color: #e0a800;
        }
        .led-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .led-button {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: linear-gradient(145deg, #6c757d, #495057);
            border: 3px solid #343a40;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            color: white;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            padding: 8px 5px 5px 5px;
        }
        .led-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        .led-button.on {
            background: linear-gradient(145deg, #ffc107, #ff9800);
            border-color: #ff6f00;
            box-shadow: 0 0 20px rgba(255, 193, 7, 0.6), 0 4px 8px rgba(0,0,0,0.2);
            color: #000;
        }
        .led-button.dragging {
            cursor: ns-resize;
        }
        .brightness-indicator {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 9px;
            background: rgba(0,0,0,0.6);
            padding: 2px 6px;
            border-radius: 3px;
            color: white;
            font-weight: bold;
            pointer-events: none;
            margin: 0;
        }
        .led-icon {
            font-size: 29px;
            margin: 0 0 2px 0;
        }
        .led-name {
            font-size: 11px;
            line-height: 1;
            word-wrap: break-word;
            margin: 0 0 2px 0;
            font-weight: bold;
        }
            margin: 0px 0 2px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-switch">
            <button class="lang-btn lang-en-btn active" id="lang-en" onclick="switchLanguage('en')" title="English"></button>
            <button class="lang-btn lang-zh-btn" id="lang-zh" onclick="switchLanguage('zh')" title="ä¸­æ–‡"></button>
        </div>
        <h1>ğŸ® <span class="lang-en">Gamepad Test</span><span class="lang-zh">æ¸¸æˆæ‰‹æŸ„æµ‹è¯•</span></h1>
        <div id="status" class="status disconnected">
            <span class="lang-en">Please connect a gamepad and press any button to activate</span><span class="lang-zh">è¯·è¿æ¥æ¸¸æˆæ‰‹æŸ„å¹¶æŒ‰ä»»æ„æŒ‰é’®æ¿€æ´»</span>
        </div>

        <div id="gamepads"></div>

        <!-- HID LED æ§åˆ¶é¢æ¿ -->
        <div class="hid-panel">
            <div class="hid-title">ğŸ’¡ <span class="lang-en">HID Light Control</span><span class="lang-zh">HID ç¯å…‰æ§åˆ¶</span></div>
            <div id="hid-status" class="hid-status disconnected">
                <span class="lang-en">Click button to connect HID device</span><span class="lang-zh">ç‚¹å‡»æŒ‰é’®è¿æ¥ HID è®¾å¤‡</span>
            </div>
            <button class="hid-connect-btn" id="hid-connect-btn" onclick="toggleHIDConnection()">ğŸ”Œ <span class="lang-en">Connect HID Device</span><span class="lang-zh">è¿æ¥ HID è®¾å¤‡</span></button>
            <div class="led-grid" id="led-container">
                <!-- LED æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // è¯­è¨€åˆ‡æ¢
        function switchLanguage(lang) {
            if (lang === 'zh') {
                document.body.classList.add('zh');
                document.getElementById('lang-en').classList.remove('active');
                document.getElementById('lang-zh').classList.add('active');
            } else {
                document.body.classList.remove('zh');
                document.getElementById('lang-en').classList.add('active');
                document.getElementById('lang-zh').classList.remove('active');
            }
        }

        // å…¨å±€çŠ¶æ€
        let gamepads = {};
        let buttonStates = {};
        let buttonCounts = {};
        let stickTrails = {}; // å­˜å‚¨æ‘‡æ†æ‹–å°¾å†å²
        let isGamepadSupported = 'getGamepads' in navigator;

        // HID ç›¸å…³å˜é‡
        let hidDevice = null;
        let ledStates = {}; // å­˜å‚¨æ¯ä¸ª LED çš„çŠ¶æ€
        let outputReportId = 0;
        let outputReportSize = 0;

        // åˆå§‹åŒ–
        if (!isGamepadSupported) {
            document.getElementById('status').innerHTML = '<span class="lang-en">Your browser does not support Gamepad API</span><span class="lang-zh">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Gamepad API</span>';
            document.getElementById('status').className = 'status disconnected';
        }

        // æ£€æŸ¥ WebHID æ”¯æŒ
        if (!('hid' in navigator)) {
            const hidStatus = document.getElementById('hid-status');
            hidStatus.innerHTML = '<span class="lang-en">WebHID API not supported</span><span class="lang-zh">ä¸æ”¯æŒ WebHID API</span>';
            hidStatus.className = 'hid-status disconnected';
        }

        // ========== HID åŠŸèƒ½ ==========
        
        function toggleHIDConnection() {
            if (hidDevice) {
                disconnectHIDDevice();
            } else {
                connectHIDDevice();
            }
        }

        function disconnectHIDDevice() {
            if (!hidDevice) return;
            
            hidDevice.close();
            hidDevice = null;
            ledStates = {};
            
            // æ›´æ–°çŠ¶æ€
            document.getElementById('hid-status').innerHTML = 
                '<span class="lang-en">Click button to connect HID device</span><span class="lang-zh">ç‚¹å‡»æŒ‰é’®è¿æ¥ HID è®¾å¤‡</span>';
            document.getElementById('hid-status').className = 'hid-status disconnected';
            document.getElementById('led-container').innerHTML = '';
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            document.getElementById('hid-connect-btn').innerHTML = 
                'ğŸ”Œ <span class="lang-en">Connect HID Device</span><span class="lang-zh">è¿æ¥ HID è®¾å¤‡</span>';
        }
        
        async function connectHIDDevice() {
            try {
                const devices = await navigator.hid.requestDevice({ filters: [] });
                
                if (devices.length === 0) {
                    return;
                }

                hidDevice = devices[0];
                await hidDevice.open();
                
                console.log('HID Device connected:', hidDevice);
                
                // è§£æ Output Report
                parseOutputReports();
                
                // æ›´æ–°çŠ¶æ€
                const deviceName = hidDevice.productName || 'HID Device';
                document.getElementById('hid-status').innerHTML = 
                    `âœ… <span class="lang-en">Connected: ${deviceName}</span><span class="lang-zh">å·²è¿æ¥: ${deviceName}</span>`;
                document.getElementById('hid-status').className = 'hid-status connected';
                
                // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                document.getElementById('hid-connect-btn').innerHTML = 
                    'ğŸ”Œ <span class="lang-en">Disconnect</span><span class="lang-zh">æ–­å¼€</span>';

                // ç›‘å¬æ–­å¼€
                hidDevice.addEventListener('disconnect', () => {
                    document.getElementById('hid-status').innerHTML = 
                        '<span class="lang-en">Device disconnected</span><span class="lang-zh">è®¾å¤‡å·²æ–­å¼€</span>';
                    document.getElementById('hid-status').className = 'hid-status disconnected';
                    document.getElementById('led-container').innerHTML = '';
                    hidDevice = null;
                    ledStates = {};
                    
                    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
                    document.getElementById('hid-connect-btn').innerHTML = 
                        'ğŸ”Œ <span class="lang-en">Connect HID Device</span><span class="lang-zh">è¿æ¥ HID è®¾å¤‡</span>';
                });

            } catch (error) {
                console.error('HID connection error:', error);
                const isZh = document.body.classList.contains('zh');
                alert(isZh ? `è¿æ¥å¤±è´¥: ${error.message}` : `Failed to connect HID device: ${error.message}`);
            }
        }

        function parseOutputReports() {
            const container = document.getElementById('led-container');
            container.innerHTML = '';
            ledStates = {};

            let ledIndex = 0;

            hidDevice.collections.forEach((collection) => {
                if (!collection.outputReports || collection.outputReports.length === 0) {
                    return;
                }

                collection.outputReports.forEach((report) => {
                    outputReportId = report.reportId;
                    
                    if (!report.items || report.items.length === 0) {
                        return;
                    }

                    // è®¡ç®—æŠ¥å‘Šæ€»å¤§å°
                    let totalBits = 0;
                    report.items.forEach(item => {
                        totalBits += (item.reportSize || 0) * (item.reportCount || 1);
                    });
                    outputReportSize = Math.ceil(totalBits / 8);

                    // ä¸ºæ¯ä¸ª item åˆ›å»º LED æŒ‰é’®
                    report.items.forEach((item) => {
                        const reportSize = item.reportSize || 8;
                        const reportCount = item.reportCount || 1;

                        // å¦‚æœæ˜¯å•å­—èŠ‚å­—æ®µï¼Œä¸ºæ¯ä¸ªè®¡æ•°åˆ›å»ºä¸€ä¸ª LED
                        for (let i = 0; i < reportCount; i++) {
                            const ledName = `${ledIndex + 1}`;
                            createLEDButton(ledIndex, ledName);
                            ledStates[ledIndex] = 0;
                            ledIndex++;
                        }
                    });
                });
            });

            if (ledIndex === 0) {
                container.innerHTML = '<div style="text-align:center;color:#6c757d;"><span class="lang-en">No output LEDs found</span><span class="lang-zh">æœªæ‰¾åˆ°è¾“å‡º LED</span></div>';
            }
        }

        function createLEDButton(index, name) {
            const container = document.getElementById('led-container');
            
            const button = document.createElement('div');
            button.className = 'led-button';
            button.id = `led-${index}`;
            button.style.position = 'relative';
            
            button.innerHTML = `
                <div class="led-name">${name}</div>
                <div class="led-icon">ğŸ’¡</div>
                <div class="brightness-indicator" id="brightness-${index}">0</div>
            `;
            
            // ç‚¹å‡»åˆ‡æ¢äº®ç­
            button.addEventListener('click', (e) => {
                if (!button.classList.contains('dragging')) {
                    toggleLED(index);
                }
            });

            // æ‹–æ‹½è°ƒæ•´äº®åº¦
            let isDragging = false;
            let startY = 0;
            let startBrightness = 0;

            button.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startBrightness = ledStates[index] || 0;
                button.classList.add('dragging');
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                // å‘ä¸Šæ‹–å¢åŠ äº®åº¦ï¼Œå‘ä¸‹æ‹–å‡å°‘äº®åº¦
                const deltaY = startY - e.clientY;
                const sensitivity = 2; // çµæ•åº¦ï¼šæ¯åƒç´ å¯¹åº”çš„äº®åº¦å˜åŒ–
                let newBrightness = startBrightness + Math.round(deltaY * sensitivity);
                
                // é™åˆ¶èŒƒå›´ 0-255
                newBrightness = Math.max(0, Math.min(255, newBrightness));
                
                // æ›´æ–°äº®åº¦
                setLEDBrightness(index, newBrightness);
                e.preventDefault();
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    button.classList.remove('dragging');
                }
            });
            
            container.appendChild(button);
            updateLEDVisual(index);
        }

        function setLEDBrightness(index, brightness) {
            ledStates[index] = brightness;
            updateLEDVisual(index);
            sendOutputReport();
        }

        function updateLEDVisual(index) {
            const button = document.getElementById(`led-${index}`);
            const indicator = document.getElementById(`brightness-${index}`);
            const brightness = ledStates[index] || 0;
            
            if (!button) return;
            
            // æ›´æ–°äº®åº¦æ˜¾ç¤º
            indicator.textContent = brightness;
            
            if (brightness === 0) {
                // å…³é—­çŠ¶æ€
                button.classList.remove('on');
                button.style.background = '';
                button.style.borderColor = '';
                button.style.boxShadow = '';
                button.style.color = '';
            } else {
                // äº®èµ·çŠ¶æ€ï¼Œæ ¹æ®äº®åº¦è°ƒæ•´è§†è§‰æ•ˆæœ
                button.classList.add('on');
                
                // è®¡ç®—è§†è§‰äº®åº¦ï¼ˆå³ä½¿äº®åº¦ä¸º1ä¹Ÿè¦æ˜æ˜¾å¯è§ï¼‰
                // å°† 1-255 æ˜ å°„åˆ° 30%-100% çš„è§†è§‰äº®åº¦
                const visualBrightness = 30 + (brightness / 255) * 70;
                
                // HSL è‰²ç›¸ï¼šä»æ©™è‰²(30)åˆ°é»„è‰²(50)
                const hue = 30 + (brightness / 255) * 20;
                const saturation = 100;
                const lightness = visualBrightness;
                
                button.style.background = `linear-gradient(145deg, 
                    hsl(${hue}, ${saturation}%, ${lightness}%), 
                    hsl(${hue - 10}, ${saturation}%, ${lightness - 10}%))`;
                button.style.borderColor = `hsl(${hue}, ${saturation}%, ${lightness - 20}%)`;
                
                // å…‰æ™•æ•ˆæœå¼ºåº¦éšäº®åº¦å˜åŒ–
                const glowIntensity = 0.2 + (brightness / 255) * 0.6;
                const glowSize = 10 + (brightness / 255) * 15;
                button.style.boxShadow = `0 0 ${glowSize}px rgba(255, 193, 7, ${glowIntensity}), 0 4px 8px rgba(0,0,0,0.2)`;
                
                // æ–‡å­—é¢œè‰²
                button.style.color = brightness > 128 ? '#000' : '#333';
            }
        }

        async function toggleLED(index) {
            if (!hidDevice) {
                const isZh = document.body.classList.contains('zh');
                alert(isZh ? 'æœªè¿æ¥è®¾å¤‡' : 'No HID device connected');
                return;
            }

            // åˆ‡æ¢çŠ¶æ€ï¼š0 -> 255, å…¶ä»– -> 0
            ledStates[index] = ledStates[index] === 0 ? 255 : 0;
            
            // æ›´æ–°è§†è§‰æ•ˆæœ
            updateLEDVisual(index);

            // å‘é€æŠ¥å‘Š
            await sendOutputReport();
        }

        async function sendOutputReport() {
            try {
                // æ„å»ºè¾“å‡ºæ•°æ®
                const data = new Uint8Array(outputReportSize);
                
                // å¡«å……æ¯ä¸ª LED çš„çŠ¶æ€
                Object.keys(ledStates).forEach(index => {
                    const byteIndex = parseInt(index);
                    if (byteIndex < data.length) {
                        data[byteIndex] = ledStates[index];
                    }
                });

                // å‘é€æŠ¥å‘Š
                await hidDevice.sendReport(outputReportId, data);
                
                console.log(`Sent Output Report ${outputReportId}:`, Array.from(data));

            } catch (error) {
                console.error('Failed to send output report:', error);
                const isZh = document.body.classList.contains('zh');
                alert(isZh ? `å‘é€å¤±è´¥: ${error.message}` : `Failed to send LED data: ${error.message}`);
            }
        }

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        window.addEventListener('gamepadconnected', (e) => {
            console.log('æ‰‹æŸ„å·²è¿æ¥:', e.gamepad);
            updateStatus();
            renderGamepads(); // æ·»åŠ è¿™è¡Œ
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('æ‰‹æŸ„å·²æ–­å¼€:', e.gamepad);
            delete gamepads[e.gamepad.index];
            delete buttonStates[e.gamepad.index];
            delete buttonCounts[e.gamepad.index];
            delete stickTrails[e.gamepad.index];
            updateStatus();
            renderGamepads();
        });

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            const gamepadList = navigator.getGamepads();
            const connectedGamepads = Array.from(gamepadList).filter(gp => gp !== null);
            
            const statusElement = document.getElementById('status');
            if (connectedGamepads.length > 0) {
                statusElement.innerHTML = `<span class="lang-en">Connected ${connectedGamepads.length} gamepad(s)</span><span class="lang-zh">å·²è¿æ¥ ${connectedGamepads.length} ä¸ªæ‰‹æŸ„</span>`;
                statusElement.className = 'status connected';
            } else {
                statusElement.innerHTML = '<span class="lang-en">Please connect a gamepad and press any button to activate</span><span class="lang-zh">è¯·è¿æ¥æ¸¸æˆæ‰‹æŸ„å¹¶æŒ‰ä»»æ„æŒ‰é’®æ¿€æ´»</span>';
                statusElement.className = 'status disconnected';
            }
        }

        // è·å–æŒ‰é’®ä¿¡æ¯ï¼ˆåç§°å’Œç±»å‹ï¼‰
        function getButtonInfo(index) {
            return { name: `${index}`, type: 'default' };
        }

        // è·å–è½´åç§°
        function getAxisName(index) {
            const axisNames = [
                '<span class="lang-en">Left X</span><span class="lang-zh">å·¦ X</span>', 
                '<span class="lang-en">Left Y</span><span class="lang-zh">å·¦ Y</span>', 
                '<span class="lang-en">Right X</span><span class="lang-zh">å³ X</span>', 
                '<span class="lang-en">Right Y</span><span class="lang-zh">å³ Y</span>'
            ];
            return axisNames[index] || `<span class="lang-en">Axis ${index}</span><span class="lang-zh">è½´ ${index}</span>`;
        }

        // æ›´æ–°æ‘‡æ†æ‹–å°¾æ•ˆæœ
        function updateStickTrail(gamepadIndex, stickName, posX, posY, canvasElement) {
            const key = `${gamepadIndex}-${stickName}`;
            const maxTrails = 15; // æœ€å¤§æ‹–å°¾ç‚¹æ•°é‡
            
            // åˆå§‹åŒ–æ‹–å°¾æ•°ç»„
            if (!stickTrails[key]) {
                stickTrails[key] = [];
            }
            
            // æ·»åŠ æ–°ä½ç½®
            stickTrails[key].push({ x: posX, y: posY, time: Date.now() });
            
            // é™åˆ¶æ‹–å°¾æ•°é‡
            if (stickTrails[key].length > maxTrails) {
                stickTrails[key].shift();
            }
            
            // æ¸…é™¤æ—§çš„æ‹–å°¾å…ƒç´ 
            if (canvasElement) {
                const oldTrails = canvasElement.querySelectorAll('.stick-2d-trail');
                oldTrails.forEach(trail => trail.remove());
                
                // åˆ›å»ºæ–°çš„æ‹–å°¾å…ƒç´ 
                stickTrails[key].forEach((pos, index) => {
                    const trail = document.createElement('div');
                    trail.className = 'stick-2d-trail';
                    trail.style.left = `${pos.x}%`;
                    trail.style.top = `${pos.y}%`;
                    
                    // è®¡ç®—é€æ˜åº¦ï¼ˆè¶Šæ—§è¶Šé€æ˜ï¼‰
                    const opacity = (index + 1) / stickTrails[key].length * 0.5;
                    trail.style.opacity = opacity;
                    
                    // è®¡ç®—å¤§å°ï¼ˆè¶Šæ—§è¶Šå°ï¼‰
                    const size = 4 + (index + 1) / stickTrails[key].length * 6;
                    trail.style.width = `${size}px`;
                    trail.style.height = `${size}px`;
                    
                    canvasElement.appendChild(trail);
                });
            }
        }

        // æ›´æ–°å•è½´æ‹–å°¾æ•ˆæœ
        function updateAxisTrail(gamepadIndex, axisIndex, position, containerElement) {
            const key = `axis-${gamepadIndex}-${axisIndex}`;
            const maxTrails = 15; // æœ€å¤§æ‹–å°¾ç‚¹æ•°é‡
            
            // åˆå§‹åŒ–æ‹–å°¾æ•°ç»„
            if (!stickTrails[key]) {
                stickTrails[key] = [];
            }
            
            // æ·»åŠ æ–°ä½ç½®
            stickTrails[key].push({ position: position, time: Date.now() });
            
            // é™åˆ¶æ‹–å°¾æ•°é‡
            if (stickTrails[key].length > maxTrails) {
                stickTrails[key].shift();
            }
            
            // æ¸…é™¤æ—§çš„æ‹–å°¾å…ƒç´ 
            if (containerElement) {
                const oldTrails = containerElement.querySelectorAll('.axis-trail');
                oldTrails.forEach(trail => trail.remove());
                
                // åˆ›å»ºæ–°çš„æ‹–å°¾å…ƒç´ 
                stickTrails[key].forEach((pos, index) => {
                    const trail = document.createElement('div');
                    trail.className = 'axis-trail';
                    trail.style.top = `${pos.position}%`;
                    
                    // è®¡ç®—é€æ˜åº¦ï¼ˆè¶Šæ—§è¶Šé€æ˜ï¼‰
                    const opacity = (index + 1) / stickTrails[key].length * 0.4;
                    trail.style.opacity = opacity;
                    
                    // è®¡ç®—é«˜åº¦ï¼ˆè¶Šæ—§è¶Šå°ï¼‰
                    const height = 2 + (index + 1) / stickTrails[key].length * 2;
                    trail.style.height = `${height}px`;
                    
                    containerElement.appendChild(trail);
                });
            }
        }

        // æ£€æµ‹æŒ‰é’®çŠ¶æ€å˜åŒ–
        function checkButtonPress(gamepadIndex, buttonIndex, isPressed) {
            const key = `${gamepadIndex}-${buttonIndex}`;
            
            // åˆå§‹åŒ–çŠ¶æ€
            if (!(key in buttonStates)) {
                buttonStates[key] = false;
                buttonCounts[key] = 0;
            }

            // æ£€æµ‹æŒ‰ä¸‹è¾¹æ²¿ï¼ˆä»æœªæŒ‰ä¸‹å˜ä¸ºæŒ‰ä¸‹ï¼‰
            if (isPressed && !buttonStates[key]) {
                buttonStates[key] = true;
                buttonCounts[key]++;
            } else if (!isPressed && buttonStates[key]) {
                buttonStates[key] = false;
            }

            // å®æ—¶æ›´æ–°è§†è§‰çŠ¶æ€ï¼ˆæŒ‰ä¸‹äº®èµ·ï¼Œæ¾å¼€ç†„ç­ï¼‰
            const buttonElement = document.getElementById(`button-${gamepadIndex}-${buttonIndex}`);
            if (buttonElement) {
                if (isPressed) {
                    buttonElement.classList.add('pressed');
                } else {
                    buttonElement.classList.remove('pressed');
                }
            }
        }



        // æ¸²æŸ“æ‰‹æŸ„ç•Œé¢
        function renderGamepads() {
            const container = document.getElementById('gamepads');
            container.innerHTML = '';

            const gamepadList = navigator.getGamepads();
            
            for (let i = 0; i < gamepadList.length; i++) {
                const gamepad = gamepadList[i];
                if (!gamepad) continue;

                const gamepadDiv = document.createElement('div');
                gamepadDiv.className = 'gamepad';

                // æŒ‰æŒ‰é’®ç±»å‹åˆ†ç»„
                const buttonGroups = {
                    default: { title: '<span class="lang-en">Buttons</span><span class="lang-zh">æŒ‰é’®</span>', buttons: [] }
                };

                gamepad.buttons.forEach((button, buttonIndex) => {
                    const buttonInfo = getButtonInfo(buttonIndex);
                    const key = `${gamepad.index}-${buttonIndex}`;
                    
                    // ç¡®ä¿åˆå§‹åŒ–è®¡æ•°
                    if (!(key in buttonCounts)) {
                        buttonCounts[key] = 0;
                    }
                    
                    const count = buttonCounts[key];
                    
                    buttonGroups.default.buttons.push({
                        index: buttonIndex,
                        name: buttonInfo.name,
                        type: buttonInfo.type,
                        count: count
                    });
                });

                let buttonsHTML = '';
                for (const [groupType, group] of Object.entries(buttonGroups)) {
                    if (group.buttons.length > 0) {
                        buttonsHTML += `
                            <div class="button-group">
                                <div class="button-group-title">${group.title}</div>
                                <div class="buttons-container">
                                    ${group.buttons.map(btn => `
                                        <div class="button-circle ${btn.type}" id="button-${gamepad.index}-${btn.index}">
                                            <div class="button-name">${btn.name}</div>
                                            <div class="button-count">${btn.count}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }

                gamepadDiv.innerHTML = `
                    <div class="gamepad-title">
                        ğŸ® ${gamepad.id} <span class="lang-en">Index</span><span class="lang-zh">ç´¢å¼•</span>: ${gamepad.index}
                        <button class="reset-btn" onclick="resetGamepad(${gamepad.index})" 
                                style="float: right; padding: 6px 12px; font-size: 14px; background-color: #6c757d;">
                            ğŸ”„ <span class="lang-en">Reset Counts</span><span class="lang-zh">å¤ä½è®¡æ•°</span>
                        </button>
                        <div style="clear: both;"></div>
                    </div>
                    ${buttonsHTML}
                    <div class="axes-section">
                        <h4><span class="lang-en">Axes</span><span class="lang-zh">æ‘‡æ†è½´</span></h4>
                        <div class="axes-grid">
                            ${gamepad.axes.length >= 2 ? `
                                <div class="stick-2d">
                                    <div class="axis-name"><span class="lang-en">Left Stick</span><span class="lang-zh">å·¦æ‘‡æ†</span></div>
                                    <div class="stick-2d-canvas" id="stick-left-${gamepad.index}">
                                        <div class="stick-2d-cross-h"></div>
                                        <div class="stick-2d-cross-v"></div>
                                        <div class="stick-2d-center"></div>
                                        <div class="stick-2d-indicator" id="stick-left-indicator-${gamepad.index}"></div>
                                    </div>
                                    <div class="stick-2d-value" id="stick-left-value-${gamepad.index}">X: 0.000, Y: 0.000</div>
                                </div>
                            ` : ''}
                            ${gamepad.axes.length >= 4 ? `
                                <div class="stick-2d">
                                    <div class="axis-name"><span class="lang-en">Right Stick</span><span class="lang-zh">å³æ‘‡æ†</span></div>
                                    <div class="stick-2d-canvas" id="stick-right-${gamepad.index}">
                                        <div class="stick-2d-cross-h"></div>
                                        <div class="stick-2d-cross-v"></div>
                                        <div class="stick-2d-center"></div>
                                        <div class="stick-2d-indicator" id="stick-right-indicator-${gamepad.index}"></div>
                                    </div>
                                    <div class="stick-2d-value" id="stick-right-value-${gamepad.index}">X: 0.000, Y: 0.000</div>
                                </div>
                            ` : ''}
                            ${gamepad.axes.map((axis, axisIndex) => `
                                <div class="axis-item">
                                    <div class="axis-name">${getAxisName(axisIndex)}</div>
                                    <div class="axis-bar">
                                        <div class="axis-center-line"></div>
                                        <div class="axis-indicator" id="axis-bar-${gamepad.index}-${axisIndex}"></div>
                                    </div>
                                    <div class="axis-value" id="axis-${gamepad.index}-${axisIndex}">${axis.toFixed(3)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(gamepadDiv);
            }
        }

        // ä¸»å¾ªç¯ - æŒç»­æ£€æµ‹æ‰‹æŸ„çŠ¶æ€
        function gameLoop() {
            const gamepadList = navigator.getGamepads();
            let needsRender = false;
            
            for (let i = 0; i < gamepadList.length; i++) {
                const gamepad = gamepadList[i];
                if (!gamepad) continue;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ‰‹æŸ„
                if (!gamepads[gamepad.index]) {
                    gamepads[gamepad.index] = true;
                    needsRender = true;
                }

                // æ£€æµ‹æŒ‰é’®çŠ¶æ€
                gamepad.buttons.forEach((button, buttonIndex) => {
                    const isPressed = button.pressed || button.value > 0.5;
                    checkButtonPress(gamepad.index, buttonIndex, isPressed);
                });

                // æ›´æ–°è½´æ˜¾ç¤º
                gamepad.axes.forEach((axis, axisIndex) => {
                    // é™åˆ¶è½´å€¼åˆ° -1 åˆ° +1 èŒƒå›´
                    const clampedAxis = Math.max(-1, Math.min(1, axis));
                    
                    const axisElement = document.getElementById(`axis-${gamepad.index}-${axisIndex}`);
                    if (axisElement) {
                        // æ˜¾ç¤ºåŸå§‹å€¼ï¼Œä½†æ ‡è®°å¦‚æœè¶…å‡ºèŒƒå›´
                        const displayValue = axis.toFixed(3);
                        const isOutOfRange = axis < -1 || axis > 1;
                        axisElement.textContent = isOutOfRange ? `${displayValue}âš ï¸` : displayValue;
                        
                        // å¦‚æœè¶…å‡ºèŒƒå›´ï¼Œæ”¹å˜é¢œè‰²
                        if (isOutOfRange) {
                            axisElement.style.color = 'red';
                            axisElement.style.fontWeight = 'bold';
                        } else {
                            axisElement.style.color = '';
                            axisElement.style.fontWeight = '';
                        }
                    }
                    
                    // æ›´æ–°è½´æ¡æ˜¾ç¤º - ä½¿ç”¨é™åˆ¶åçš„å€¼
                    const axisBarElement = document.getElementById(`axis-bar-${gamepad.index}-${axisIndex}`);
                    const axisBarContainer = axisBarElement ? axisBarElement.parentElement : null;
                    if (axisBarElement) {
                        const position = ((clampedAxis + 1) / 2) * 94; // ä½¿ç”¨é™åˆ¶åçš„å€¼
                        axisBarElement.style.top = `${position}%`;
                        
                        // å¦‚æœåŸå§‹å€¼è¶…å‡ºèŒƒå›´ï¼Œæ”¹å˜æŒ‡ç¤ºå™¨é¢œè‰²
                        if (axis < -1 || axis > 1) {
                            axisBarElement.style.background = '#dc3545'; // çº¢è‰²è­¦å‘Š
                        } else {
                            axisBarElement.style.background = '#007bff'; // é»˜è®¤è“è‰²
                        }
                        
                        // æ·»åŠ æ‹–å°¾æ•ˆæœ
                        updateAxisTrail(gamepad.index, axisIndex, position, axisBarContainer);
                    }
                });

                // æ›´æ–°2Dæ‘‡æ†æ˜¾ç¤º
                if (gamepad.axes.length >= 2) {
                    const leftX = Math.max(-1, Math.min(1, gamepad.axes[0]));
                    const leftY = Math.max(-1, Math.min(1, gamepad.axes[1]));
                    const leftIndicator = document.getElementById(`stick-left-indicator-${gamepad.index}`);
                    const leftValue = document.getElementById(`stick-left-value-${gamepad.index}`);
                    const leftCanvas = document.getElementById(`stick-left-${gamepad.index}`);
                    if (leftIndicator) {
                        const posX = ((leftX + 1) / 2) * 100;
                        const posY = ((leftY + 1) / 2) * 100;
                        leftIndicator.style.left = `${posX}%`;
                        leftIndicator.style.top = `${posY}%`;
                        
                        // æ·»åŠ æ‹–å°¾æ•ˆæœ
                        updateStickTrail(gamepad.index, 'left', posX, posY, leftCanvas);
                    }
                    if (leftValue) {
                        leftValue.textContent = `X: ${gamepad.axes[0].toFixed(3)}, Y: ${gamepad.axes[1].toFixed(3)}`;
                    }
                }
                
                if (gamepad.axes.length >= 4) {
                    const rightX = Math.max(-1, Math.min(1, gamepad.axes[2]));
                    const rightY = Math.max(-1, Math.min(1, gamepad.axes[3]));
                    const rightIndicator = document.getElementById(`stick-right-indicator-${gamepad.index}`);
                    const rightValue = document.getElementById(`stick-right-value-${gamepad.index}`);
                    const rightCanvas = document.getElementById(`stick-right-${gamepad.index}`);
                    if (rightIndicator) {
                        const posX = ((rightX + 1) / 2) * 100;
                        const posY = ((rightY + 1) / 2) * 100;
                        rightIndicator.style.left = `${posX}%`;
                        rightIndicator.style.top = `${posY}%`;
                        
                        // æ·»åŠ æ‹–å°¾æ•ˆæœ
                        updateStickTrail(gamepad.index, 'right', posX, posY, rightCanvas);
                    }
                    if (rightValue) {
                        rightValue.textContent = `X: ${gamepad.axes[2].toFixed(3)}, Y: ${gamepad.axes[3].toFixed(3)}`;
                    }
                }

                // æ›´æ–°æŒ‰é’®è®¡æ•°æ˜¾ç¤º
                gamepad.buttons.forEach((button, buttonIndex) => {
                    const key = `${gamepad.index}-${buttonIndex}`;
                    const count = buttonCounts[key] || 0;
                    const countElement = document.querySelector(`#button-${gamepad.index}-${buttonIndex} .button-count`);
                    if (countElement) {
                        countElement.textContent = count;
                    }
                });
            }

            if (needsRender) {
                renderGamepads();
            }

            updateStatus();
            requestAnimationFrame(gameLoop);
        }

        // å¤ä½æ‰€æœ‰è®¡æ•°
        function resetAllCounts() {
            buttonCounts = {};
            buttonStates = {};
            renderGamepads();
        }

        // å¤ä½å½“å‰æ‰‹æŸ„è®¡æ•°
        function resetCurrentGamepad() {
            const gamepadList = navigator.getGamepads();
            const connectedGamepads = Array.from(gamepadList).filter(gp => gp !== null);
            
            if (connectedGamepads.length === 0) {
                const isZh = document.body.classList.contains('zh');
                alert(isZh ? 'æ²¡æœ‰è¿æ¥çš„æ‰‹æŸ„' : 'No gamepad connected');
                return;
            }

            if (connectedGamepads.length === 1) {
                const gamepad = connectedGamepads[0];
                // å¤ä½è¿™ä¸ªæ‰‹æŸ„çš„æ‰€æœ‰æŒ‰é’®è®¡æ•°
                for (let i = 0; i < gamepad.buttons.length; i++) {
                    const key = `${gamepad.index}-${i}`;
                    buttonCounts[key] = 0;
                    buttonStates[key] = false;
                }
                renderGamepads();
            } else {
                // å¤šä¸ªæ‰‹æŸ„ï¼Œè®©ç”¨æˆ·é€‰æ‹©
                const isZh = document.body.classList.contains('zh');
                let gamepadIndex = prompt(isZh 
                    ? `æ£€æµ‹åˆ° ${connectedGamepads.length} ä¸ªæ‰‹æŸ„ï¼Œè¯·è¾“å…¥è¦å¤ä½çš„æ‰‹æŸ„ç´¢å¼• (0-${connectedGamepads.length-1}):` 
                    : `Detected ${connectedGamepads.length} gamepads, enter gamepad index to reset (0-${connectedGamepads.length-1}):`);
                gamepadIndex = parseInt(gamepadIndex);
                
                if (isNaN(gamepadIndex) || gamepadIndex < 0 || gamepadIndex >= gamepadList.length) {
                    const isZh = document.body.classList.contains('zh');
                    alert(isZh ? 'æ— æ•ˆçš„æ‰‹æŸ„ç´¢å¼•' : 'Invalid gamepad index');
                    return;
                }

                const gamepad = gamepadList[gamepadIndex];
                if (!gamepad) {
                    const isZh = document.body.classList.contains('zh');
                    alert(isZh ? 'è¯¥ç´¢å¼•çš„æ‰‹æŸ„æœªè¿æ¥' : 'Gamepad at this index is not connected');
                    return;
                }

                for (let i = 0; i < gamepad.buttons.length; i++) {
                    const key = `${gamepadIndex}-${i}`;
                    buttonCounts[key] = 0;
                    buttonStates[key] = false;
                }
                renderGamepads();
            }
        }

        // å¤ä½æŒ‡å®šæ‰‹æŸ„
        function resetGamepad(gamepadIndex) {
            const gamepadList = navigator.getGamepads();
            const gamepad = gamepadList[gamepadIndex];
            
            if (!gamepad) {
                const isZh = document.body.classList.contains('zh');
                alert(isZh ? 'æ‰‹æŸ„æœªæ‰¾åˆ°' : 'Gamepad not found');
                return;
            }

            for (let i = 0; i < gamepad.buttons.length; i++) {
                const key = `${gamepadIndex}-${i}`;
                buttonCounts[key] = 0;
                buttonStates[key] = false;
            }
            renderGamepads();
        }

        // å¯åŠ¨ä¸»å¾ªç¯
        updateStatus();
        renderGamepads();
        gameLoop();
    </script>
</body>
</html>