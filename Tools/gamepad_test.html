<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamepad Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .status {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        .reset-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
        }
        .reset-btn:hover {
            background-color: #c82333;
        }
        .gamepad {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .gamepad-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: flex-start;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .button-circle {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(145deg, #e9ecef, #ffffff);
            border: 3px solid #dee2e6;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.066s ease;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .button-circle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .button-circle.pressed {
            background: linear-gradient(145deg, #28a745, #34ce57);
            border-color: #1e7e34;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(40, 167, 69, 0.5);
        }
        .button-name {
            font-weight: bold;
            font-size: 10px;
            margin-bottom: 3px;
            text-align: center;
            line-height: 1;
        }
        .button-count {
            font-size: 16px;
            font-weight: bold;
            color: #007bff;
        }
        .button-circle.pressed .button-count {
            color: white;
        }
        /* ç‰¹æ®ŠæŒ‰é’®é¢œè‰² */
        .button-circle.action {
            background: linear-gradient(145deg, #ffeaa7, #fdcb6e);
            border-color: #e17055;
        }
        .button-circle.shoulder {
            background: linear-gradient(145deg, #a29bfe, #6c5ce7);
            color: white;
        }
        .button-circle.dpad {
            background: linear-gradient(145deg, #fd79a8, #e84393);
            color: white;
        }
        .button-circle.system {
            background: linear-gradient(145deg, #636e72, #2d3436);
            color: white;
        }
        .axes-section {
            margin-top: 20px;
        }
        .axes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
            gap: 10px;
        }
        .axis-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
        }
        .axis-name {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .axis-value {
            font-size: 11px;
            font-family: monospace;
            margin-top: 5px;
            color: #495057;
        }
        .axis-bar {
            width: 35%;
            height: 100px;
            background: linear-gradient(to bottom, #e9ecef 0%, #f8f9fa 50%, #e9ecef 100%);
            border: 1px solid #ced4da;
            border-radius: 4px;
            position: relative;
            margin: 5px auto;
        }
        .axis-indicator {
            position: absolute;
            width: 200%;
            height: 6px;
            background: #007bff;
            border-radius: 3px;
            box-shadow: 0 0 4px rgba(0, 123, 255, 0.5);
            left: -50%;
            z-index: 10;
        }
        .axis-trail {
            position: absolute;
            width: 200%;
            height: 4px;
            background: #007bff;
            border-radius: 2px;
            left: -50%;
            pointer-events: none;
            transition: opacity 0.6s ease;
        }
        .axis-center-line {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #6c757d;
            transform: translateY(-50%);
        }

        .stick-2d {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            text-align: center;
            grid-column: span 2;
        }
        .stick-2d-canvas {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
            border: 2px solid #ced4da;
            border-radius: 50%;
            position: relative;
            margin: 5px auto;
        }
        .stick-2d-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 2px;
            background: #6c757d;
            transform: translate(-50%, -50%);
        }
        .stick-2d-cross-h {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #adb5bd;
            transform: translateY(-50%);
        }
        .stick-2d-cross-v {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 1px;
            background: #adb5bd;
            transform: translateX(-50%);
        }
        .stick-2d-indicator {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #007bff;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.6);
            transform: translate(-50%, -50%);
            z-index: 10;
        }
        .stick-2d-trail {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #007bff;
            transform: translate(-50%, -50%);
            pointer-events: none;
            transition: opacity 0.6s ease;
        }
        .stick-2d-value {
            font-size: 11px;
            font-family: monospace;
            margin-top: 5px;
            color: #495057;
        }

        .button-group {
            margin-bottom: 20px;
        }
        .button-group-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® Gamepad Test æ¸¸æˆæ‰‹æŸ„æµ‹è¯•</h1>
        <div id="status" class="status disconnected">
            Please connect a gamepad and press any button to activate è¯·è¿æ¥æ¸¸æˆæ‰‹æŸ„å¹¶æŒ‰ä»»æ„æŒ‰é’®æ¿€æ´»
        </div>

        <div id="gamepads"></div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let gamepads = {};
        let buttonStates = {};
        let buttonCounts = {};
        let stickTrails = {}; // å­˜å‚¨æ‘‡æ†æ‹–å°¾å†å²
        let isGamepadSupported = 'getGamepads' in navigator;

        // åˆå§‹åŒ–
        if (!isGamepadSupported) {
            document.getElementById('status').textContent = 'Your browser does not support Gamepad API (æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Gamepad API)';
            document.getElementById('status').className = 'status disconnected';
        }

        // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
        window.addEventListener('gamepadconnected', (e) => {
            console.log('æ‰‹æŸ„å·²è¿æ¥:', e.gamepad);
            updateStatus();
            renderGamepads(); // æ·»åŠ è¿™è¡Œ
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('æ‰‹æŸ„å·²æ–­å¼€:', e.gamepad);
            delete gamepads[e.gamepad.index];
            delete buttonStates[e.gamepad.index];
            delete buttonCounts[e.gamepad.index];
            delete stickTrails[e.gamepad.index];
            updateStatus();
            renderGamepads();
        });

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus() {
            const gamepadList = navigator.getGamepads();
            const connectedGamepads = Array.from(gamepadList).filter(gp => gp !== null);
            
            const statusElement = document.getElementById('status');
            if (connectedGamepads.length > 0) {
                statusElement.textContent = `Connected ${connectedGamepads.length} gamepad(s) (å·²è¿æ¥ ${connectedGamepads.length} ä¸ªæ‰‹æŸ„)`;
                statusElement.className = 'status connected';
            } else {
                statusElement.textContent = 'Please connect a gamepad and press any button to activate (è¯·è¿æ¥æ¸¸æˆæ‰‹æŸ„å¹¶æŒ‰ä»»æ„æŒ‰é’®æ¿€æ´»)';
                statusElement.className = 'status disconnected';
            }
        }

        // è·å–æŒ‰é’®ä¿¡æ¯ï¼ˆåç§°å’Œç±»å‹ï¼‰
        function getButtonInfo(index) {
            return { name: `${index}`, type: 'default' };
        }

        // è·å–è½´åç§°
        function getAxisName(index) {
            const axisNames = [
                'Left X<br>å·¦ X', 'Left Y<br>å·¦ Y', 
                'Right X<br>å³ X', 'Right Y<br>å³ Y'
            ];
            return axisNames[index] || `Axis ${index}<br>è½´ ${index}`;
        }

        // æ›´æ–°æ‘‡æ†æ‹–å°¾æ•ˆæœ
        function updateStickTrail(gamepadIndex, stickName, posX, posY, canvasElement) {
            const key = `${gamepadIndex}-${stickName}`;
            const maxTrails = 15; // æœ€å¤§æ‹–å°¾ç‚¹æ•°é‡
            
            // åˆå§‹åŒ–æ‹–å°¾æ•°ç»„
            if (!stickTrails[key]) {
                stickTrails[key] = [];
            }
            
            // æ·»åŠ æ–°ä½ç½®
            stickTrails[key].push({ x: posX, y: posY, time: Date.now() });
            
            // é™åˆ¶æ‹–å°¾æ•°é‡
            if (stickTrails[key].length > maxTrails) {
                stickTrails[key].shift();
            }
            
            // æ¸…é™¤æ—§çš„æ‹–å°¾å…ƒç´ 
            if (canvasElement) {
                const oldTrails = canvasElement.querySelectorAll('.stick-2d-trail');
                oldTrails.forEach(trail => trail.remove());
                
                // åˆ›å»ºæ–°çš„æ‹–å°¾å…ƒç´ 
                stickTrails[key].forEach((pos, index) => {
                    const trail = document.createElement('div');
                    trail.className = 'stick-2d-trail';
                    trail.style.left = `${pos.x}%`;
                    trail.style.top = `${pos.y}%`;
                    
                    // è®¡ç®—é€æ˜åº¦ï¼ˆè¶Šæ—§è¶Šé€æ˜ï¼‰
                    const opacity = (index + 1) / stickTrails[key].length * 0.5;
                    trail.style.opacity = opacity;
                    
                    // è®¡ç®—å¤§å°ï¼ˆè¶Šæ—§è¶Šå°ï¼‰
                    const size = 4 + (index + 1) / stickTrails[key].length * 6;
                    trail.style.width = `${size}px`;
                    trail.style.height = `${size}px`;
                    
                    canvasElement.appendChild(trail);
                });
            }
        }

        // æ›´æ–°å•è½´æ‹–å°¾æ•ˆæœ
        function updateAxisTrail(gamepadIndex, axisIndex, position, containerElement) {
            const key = `axis-${gamepadIndex}-${axisIndex}`;
            const maxTrails = 15; // æœ€å¤§æ‹–å°¾ç‚¹æ•°é‡
            
            // åˆå§‹åŒ–æ‹–å°¾æ•°ç»„
            if (!stickTrails[key]) {
                stickTrails[key] = [];
            }
            
            // æ·»åŠ æ–°ä½ç½®
            stickTrails[key].push({ position: position, time: Date.now() });
            
            // é™åˆ¶æ‹–å°¾æ•°é‡
            if (stickTrails[key].length > maxTrails) {
                stickTrails[key].shift();
            }
            
            // æ¸…é™¤æ—§çš„æ‹–å°¾å…ƒç´ 
            if (containerElement) {
                const oldTrails = containerElement.querySelectorAll('.axis-trail');
                oldTrails.forEach(trail => trail.remove());
                
                // åˆ›å»ºæ–°çš„æ‹–å°¾å…ƒç´ 
                stickTrails[key].forEach((pos, index) => {
                    const trail = document.createElement('div');
                    trail.className = 'axis-trail';
                    trail.style.top = `${pos.position}%`;
                    
                    // è®¡ç®—é€æ˜åº¦ï¼ˆè¶Šæ—§è¶Šé€æ˜ï¼‰
                    const opacity = (index + 1) / stickTrails[key].length * 0.4;
                    trail.style.opacity = opacity;
                    
                    // è®¡ç®—é«˜åº¦ï¼ˆè¶Šæ—§è¶Šå°ï¼‰
                    const height = 2 + (index + 1) / stickTrails[key].length * 2;
                    trail.style.height = `${height}px`;
                    
                    containerElement.appendChild(trail);
                });
            }
        }

        // æ£€æµ‹æŒ‰é’®çŠ¶æ€å˜åŒ–
        function checkButtonPress(gamepadIndex, buttonIndex, isPressed) {
            const key = `${gamepadIndex}-${buttonIndex}`;
            
            // åˆå§‹åŒ–çŠ¶æ€
            if (!(key in buttonStates)) {
                buttonStates[key] = false;
                buttonCounts[key] = 0;
            }

            // æ£€æµ‹æŒ‰ä¸‹è¾¹æ²¿ï¼ˆä»æœªæŒ‰ä¸‹å˜ä¸ºæŒ‰ä¸‹ï¼‰
            if (isPressed && !buttonStates[key]) {
                buttonStates[key] = true;
                buttonCounts[key]++;
            } else if (!isPressed && buttonStates[key]) {
                buttonStates[key] = false;
            }

            // å®æ—¶æ›´æ–°è§†è§‰çŠ¶æ€ï¼ˆæŒ‰ä¸‹äº®èµ·ï¼Œæ¾å¼€ç†„ç­ï¼‰
            const buttonElement = document.getElementById(`button-${gamepadIndex}-${buttonIndex}`);
            if (buttonElement) {
                if (isPressed) {
                    buttonElement.classList.add('pressed');
                } else {
                    buttonElement.classList.remove('pressed');
                }
            }
        }



        // æ¸²æŸ“æ‰‹æŸ„ç•Œé¢
        function renderGamepads() {
            const container = document.getElementById('gamepads');
            container.innerHTML = '';

            const gamepadList = navigator.getGamepads();
            
            for (let i = 0; i < gamepadList.length; i++) {
                const gamepad = gamepadList[i];
                if (!gamepad) continue;

                const gamepadDiv = document.createElement('div');
                gamepadDiv.className = 'gamepad';

                // æŒ‰æŒ‰é’®ç±»å‹åˆ†ç»„
                const buttonGroups = {
                    default: { title: 'Buttons æŒ‰é’®', buttons: [] }
                };

                gamepad.buttons.forEach((button, buttonIndex) => {
                    const buttonInfo = getButtonInfo(buttonIndex);
                    const key = `${gamepad.index}-${buttonIndex}`;
                    
                    // ç¡®ä¿åˆå§‹åŒ–è®¡æ•°
                    if (!(key in buttonCounts)) {
                        buttonCounts[key] = 0;
                    }
                    
                    const count = buttonCounts[key];
                    
                    buttonGroups.default.buttons.push({
                        index: buttonIndex,
                        name: buttonInfo.name,
                        type: buttonInfo.type,
                        count: count
                    });
                });

                let buttonsHTML = '';
                for (const [groupType, group] of Object.entries(buttonGroups)) {
                    if (group.buttons.length > 0) {
                        buttonsHTML += `
                            <div class="button-group">
                                <div class="button-group-title">${group.title}</div>
                                <div class="buttons-container">
                                    ${group.buttons.map(btn => `
                                        <div class="button-circle ${btn.type}" id="button-${gamepad.index}-${btn.index}">
                                            <div class="button-name">${btn.name}</div>
                                            <div class="button-count">${btn.count}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                }

                gamepadDiv.innerHTML = `
                    <div class="gamepad-title">
                        ğŸ® ${gamepad.id} Index ç´¢å¼•: ${gamepad.index}
                        <button class="reset-btn" onclick="resetGamepad(${gamepad.index})" 
                                style="float: right; padding: 6px 12px; font-size: 14px; background-color: #6c757d;">
                            ğŸ”„ Reset Counts å¤ä½è®¡æ•°
                        </button>
                        <div style="clear: both;"></div>
                    </div>
                    ${buttonsHTML}
                    <div class="axes-section">
                        <h4>Axes æ‘‡æ†è½´</h4>
                        <div class="axes-grid">
                            ${gamepad.axes.length >= 2 ? `
                                <div class="stick-2d">
                                    <div class="axis-name">Left Stick<br>å·¦æ‘‡æ†</div>
                                    <div class="stick-2d-canvas" id="stick-left-${gamepad.index}">
                                        <div class="stick-2d-cross-h"></div>
                                        <div class="stick-2d-cross-v"></div>
                                        <div class="stick-2d-center"></div>
                                        <div class="stick-2d-indicator" id="stick-left-indicator-${gamepad.index}"></div>
                                    </div>
                                    <div class="stick-2d-value" id="stick-left-value-${gamepad.index}">X: 0.000, Y: 0.000</div>
                                </div>
                            ` : ''}
                            ${gamepad.axes.length >= 4 ? `
                                <div class="stick-2d">
                                    <div class="axis-name">Right Stick<br>å³æ‘‡æ†</div>
                                    <div class="stick-2d-canvas" id="stick-right-${gamepad.index}">
                                        <div class="stick-2d-cross-h"></div>
                                        <div class="stick-2d-cross-v"></div>
                                        <div class="stick-2d-center"></div>
                                        <div class="stick-2d-indicator" id="stick-right-indicator-${gamepad.index}"></div>
                                    </div>
                                    <div class="stick-2d-value" id="stick-right-value-${gamepad.index}">X: 0.000, Y: 0.000</div>
                                </div>
                            ` : ''}
                            ${gamepad.axes.map((axis, axisIndex) => `
                                <div class="axis-item">
                                    <div class="axis-name">${getAxisName(axisIndex)}</div>
                                    <div class="axis-bar">
                                        <div class="axis-center-line"></div>
                                        <div class="axis-indicator" id="axis-bar-${gamepad.index}-${axisIndex}"></div>
                                    </div>
                                    <div class="axis-value" id="axis-${gamepad.index}-${axisIndex}">${axis.toFixed(3)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                container.appendChild(gamepadDiv);
            }
        }

        // ä¸»å¾ªç¯ - æŒç»­æ£€æµ‹æ‰‹æŸ„çŠ¶æ€
        function gameLoop() {
            const gamepadList = navigator.getGamepads();
            let needsRender = false;
            
            for (let i = 0; i < gamepadList.length; i++) {
                const gamepad = gamepadList[i];
                if (!gamepad) continue;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ–°æ‰‹æŸ„
                if (!gamepads[gamepad.index]) {
                    gamepads[gamepad.index] = true;
                    needsRender = true;
                }

                // æ£€æµ‹æŒ‰é’®çŠ¶æ€
                gamepad.buttons.forEach((button, buttonIndex) => {
                    const isPressed = button.pressed || button.value > 0.5;
                    checkButtonPress(gamepad.index, buttonIndex, isPressed);
                });

                // æ›´æ–°è½´æ˜¾ç¤º
                gamepad.axes.forEach((axis, axisIndex) => {
                    // é™åˆ¶è½´å€¼åˆ° -1 åˆ° +1 èŒƒå›´
                    const clampedAxis = Math.max(-1, Math.min(1, axis));
                    
                    const axisElement = document.getElementById(`axis-${gamepad.index}-${axisIndex}`);
                    if (axisElement) {
                        // æ˜¾ç¤ºåŸå§‹å€¼ï¼Œä½†æ ‡è®°å¦‚æœè¶…å‡ºèŒƒå›´
                        const displayValue = axis.toFixed(3);
                        const isOutOfRange = axis < -1 || axis > 1;
                        axisElement.textContent = isOutOfRange ? `${displayValue}âš ï¸` : displayValue;
                        
                        // å¦‚æœè¶…å‡ºèŒƒå›´ï¼Œæ”¹å˜é¢œè‰²
                        if (isOutOfRange) {
                            axisElement.style.color = 'red';
                            axisElement.style.fontWeight = 'bold';
                        } else {
                            axisElement.style.color = '';
                            axisElement.style.fontWeight = '';
                        }
                    }
                    
                    // æ›´æ–°è½´æ¡æ˜¾ç¤º - ä½¿ç”¨é™åˆ¶åçš„å€¼
                    const axisBarElement = document.getElementById(`axis-bar-${gamepad.index}-${axisIndex}`);
                    const axisBarContainer = axisBarElement ? axisBarElement.parentElement : null;
                    if (axisBarElement) {
                        const position = ((clampedAxis + 1) / 2) * 94; // ä½¿ç”¨é™åˆ¶åçš„å€¼
                        axisBarElement.style.top = `${position}%`;
                        
                        // å¦‚æœåŸå§‹å€¼è¶…å‡ºèŒƒå›´ï¼Œæ”¹å˜æŒ‡ç¤ºå™¨é¢œè‰²
                        if (axis < -1 || axis > 1) {
                            axisBarElement.style.background = '#dc3545'; // çº¢è‰²è­¦å‘Š
                        } else {
                            axisBarElement.style.background = '#007bff'; // é»˜è®¤è“è‰²
                        }
                        
                        // æ·»åŠ æ‹–å°¾æ•ˆæœ
                        updateAxisTrail(gamepad.index, axisIndex, position, axisBarContainer);
                    }
                });

                // æ›´æ–°2Dæ‘‡æ†æ˜¾ç¤º
                if (gamepad.axes.length >= 2) {
                    const leftX = Math.max(-1, Math.min(1, gamepad.axes[0]));
                    const leftY = Math.max(-1, Math.min(1, gamepad.axes[1]));
                    const leftIndicator = document.getElementById(`stick-left-indicator-${gamepad.index}`);
                    const leftValue = document.getElementById(`stick-left-value-${gamepad.index}`);
                    const leftCanvas = document.getElementById(`stick-left-${gamepad.index}`);
                    if (leftIndicator) {
                        const posX = ((leftX + 1) / 2) * 100;
                        const posY = ((leftY + 1) / 2) * 100;
                        leftIndicator.style.left = `${posX}%`;
                        leftIndicator.style.top = `${posY}%`;
                        
                        // æ·»åŠ æ‹–å°¾æ•ˆæœ
                        updateStickTrail(gamepad.index, 'left', posX, posY, leftCanvas);
                    }
                    if (leftValue) {
                        leftValue.textContent = `X: ${gamepad.axes[0].toFixed(3)}, Y: ${gamepad.axes[1].toFixed(3)}`;
                    }
                }
                
                if (gamepad.axes.length >= 4) {
                    const rightX = Math.max(-1, Math.min(1, gamepad.axes[2]));
                    const rightY = Math.max(-1, Math.min(1, gamepad.axes[3]));
                    const rightIndicator = document.getElementById(`stick-right-indicator-${gamepad.index}`);
                    const rightValue = document.getElementById(`stick-right-value-${gamepad.index}`);
                    const rightCanvas = document.getElementById(`stick-right-${gamepad.index}`);
                    if (rightIndicator) {
                        const posX = ((rightX + 1) / 2) * 100;
                        const posY = ((rightY + 1) / 2) * 100;
                        rightIndicator.style.left = `${posX}%`;
                        rightIndicator.style.top = `${posY}%`;
                        
                        // æ·»åŠ æ‹–å°¾æ•ˆæœ
                        updateStickTrail(gamepad.index, 'right', posX, posY, rightCanvas);
                    }
                    if (rightValue) {
                        rightValue.textContent = `X: ${gamepad.axes[2].toFixed(3)}, Y: ${gamepad.axes[3].toFixed(3)}`;
                    }
                }

                // æ›´æ–°æŒ‰é’®è®¡æ•°æ˜¾ç¤º
                gamepad.buttons.forEach((button, buttonIndex) => {
                    const key = `${gamepad.index}-${buttonIndex}`;
                    const count = buttonCounts[key] || 0;
                    const countElement = document.querySelector(`#button-${gamepad.index}-${buttonIndex} .button-count`);
                    if (countElement) {
                        countElement.textContent = count;
                    }
                });
            }

            if (needsRender) {
                renderGamepads();
            }

            updateStatus();
            requestAnimationFrame(gameLoop);
        }

        // å¤ä½æ‰€æœ‰è®¡æ•°
        function resetAllCounts() {
            buttonCounts = {};
            buttonStates = {};
            renderGamepads();
        }

        // å¤ä½å½“å‰æ‰‹æŸ„è®¡æ•°
        function resetCurrentGamepad() {
            const gamepadList = navigator.getGamepads();
            const connectedGamepads = Array.from(gamepadList).filter(gp => gp !== null);
            
            if (connectedGamepads.length === 0) {
                alert('No gamepad connected æ²¡æœ‰è¿æ¥çš„æ‰‹æŸ„');
                return;
            }

            if (connectedGamepads.length === 1) {
                const gamepad = connectedGamepads[0];
                // å¤ä½è¿™ä¸ªæ‰‹æŸ„çš„æ‰€æœ‰æŒ‰é’®è®¡æ•°
                for (let i = 0; i < gamepad.buttons.length; i++) {
                    const key = `${gamepad.index}-${i}`;
                    buttonCounts[key] = 0;
                    buttonStates[key] = false;
                }
                renderGamepads();
            } else {
                // å¤šä¸ªæ‰‹æŸ„ï¼Œè®©ç”¨æˆ·é€‰æ‹©
                let gamepadIndex = prompt(`Detected ${connectedGamepads.length} gamepads, enter gamepad index to reset (0-${connectedGamepads.length-1}) (æ£€æµ‹åˆ° ${connectedGamepads.length} ä¸ªæ‰‹æŸ„ï¼Œè¯·è¾“å…¥è¦å¤ä½çš„æ‰‹æŸ„ç´¢å¼• (0-${connectedGamepads.length-1})):`);
                gamepadIndex = parseInt(gamepadIndex);
                
                if (isNaN(gamepadIndex) || gamepadIndex < 0 || gamepadIndex >= gamepadList.length) {
                    alert('Invalid gamepad index æ— æ•ˆçš„æ‰‹æŸ„ç´¢å¼•');
                    return;
                }

                const gamepad = gamepadList[gamepadIndex];
                if (!gamepad) {
                    alert('Gamepad at this index is not connected è¯¥ç´¢å¼•çš„æ‰‹æŸ„æœªè¿æ¥');
                    return;
                }

                for (let i = 0; i < gamepad.buttons.length; i++) {
                    const key = `${gamepadIndex}-${i}`;
                    buttonCounts[key] = 0;
                    buttonStates[key] = false;
                }
                renderGamepads();
            }
        }

        // å¤ä½æŒ‡å®šæ‰‹æŸ„
        function resetGamepad(gamepadIndex) {
            const gamepadList = navigator.getGamepads();
            const gamepad = gamepadList[gamepadIndex];
            
            if (!gamepad) {
                alert('Gamepad not found æ‰‹æŸ„æœªæ‰¾åˆ°');
                return;
            }

            for (let i = 0; i < gamepad.buttons.length; i++) {
                const key = `${gamepadIndex}-${i}`;
                buttonCounts[key] = 0;
                buttonStates[key] = false;
            }
            renderGamepads();
        }

        // å¯åŠ¨ä¸»å¾ªç¯
        updateStatus();
        renderGamepads();
        gameLoop();
    </script>
</body>
</html>